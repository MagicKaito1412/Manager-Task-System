var moment = require('moment');
var semver = require('semver');

module.exports = function(grunt) {

	function updateVersion(version) {
		var pkg = grunt.file.readJSON('package.json');
		pkg.version = version;
		var content = JSON.stringify(pkg, null, '\t');
		grunt.file.write("package.json", content);
	}

	var pkgVersion = grunt.file.readJSON('package.json').version;

	grunt.initConfig({
	});

	grunt.registerTask('build', function (target) {
		var version = pkgVersion;
		var channel = grunt.option('channel');
		var isDevel = target === "dev" || channel === "SNAPSHOT";
		if (isDevel && !channel) {
			channel = "SNAPSHOT";
		}

		if (isDevel) {
			// pkgVersino could be already with prerelease suffix, cut it off
			if (semver.prerelease(pkgVersion) != null) {
				pkgVersion = semver.major(pkgVersion) + "." + semver.minor(pkgVersion) + "." + semver.patch(pkgVersion)
			}

			version = pkgVersion + "-" + channel;
			if (channel === "SNAPSHOT") {
				version = version + "-" + moment(new Date()).format("YYMMDDTHHmm");
			}
			updateVersion(version);
		}

		grunt.log.writeln('Production version: ' + version);
		grunt.log.writeln("##teamcity[buildNumber '" + version + "']");
	});
}